{"version":3,"file":"metadata-W-pHA1-K.mjs","names":[],"sources":["../src/utils/config.ts","../src/api/client.ts","../src/api/metadata.ts"],"sourcesContent":["export const DEFAULT_METADATA_API_BASE =\n  \"https://dev-prediction-markets-api.dflow.net\";\nexport const DEFAULT_TRADE_API_BASE = \"https://dev-quote-api.dflow.net\";\n\nexport function getMetadataApiBase(): string {\n  return (\n    process.env.METADATA_API_BASE ||\n    process.env.DFLOW_METADATA_API_URL ||\n    DEFAULT_METADATA_API_BASE\n  );\n}\n\nexport function getTradeApiBase(): string {\n  return (\n    process.env.TRADE_API_BASE ||\n    process.env.DFLOW_TRADE_API_URL ||\n    DEFAULT_TRADE_API_BASE\n  );\n}\n\nexport function getApiKey(): string | undefined {\n  return process.env.DFLOW_API_KEY || process.env.PREDICTARENA_API_KEY;\n}\n","import { getApiKey } from \"../utils/config\";\n\nexport class ApiError extends Error {\n  status: number;\n  url: string;\n  body: unknown;\n\n  constructor(message: string, status: number, url: string, body: unknown) {\n    super(message);\n    this.name = \"ApiError\";\n    this.status = status;\n    this.url = url;\n    this.body = body;\n  }\n}\n\nexport class NetworkError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = \"NetworkError\";\n  }\n}\n\nexport interface RequestOptions {\n  method?: \"GET\" | \"POST\";\n  query?: Record<string, string | number | boolean | undefined | null>;\n  body?: unknown;\n  headers?: Record<string, string>;\n  timeoutMs?: number;\n  retries?: number;\n}\n\nconst DEFAULT_TIMEOUT_MS = 15_000;\nconst DEFAULT_RETRIES = 2;\n\nfunction buildUrl(baseUrl: string, path: string, query?: RequestOptions[\"query\"]) {\n  const url = new URL(path, baseUrl);\n  if (query) {\n    for (const [key, value] of Object.entries(query)) {\n      if (value === undefined || value === null) continue;\n      url.searchParams.set(key, String(value));\n    }\n  }\n  return url.toString();\n}\n\nfunction sleep(ms: number) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nexport async function requestJson<T>(\n  baseUrl: string,\n  path: string,\n  options: RequestOptions = {},\n): Promise<T> {\n  const url = buildUrl(baseUrl, path, options.query);\n  const method = options.method ?? \"GET\";\n  const timeoutMs = options.timeoutMs ?? DEFAULT_TIMEOUT_MS;\n  const retries = options.retries ?? DEFAULT_RETRIES;\n  const apiKey = getApiKey();\n\n  const headers: Record<string, string> = {\n    ...(options.headers ?? {}),\n  };\n  if (apiKey) headers[\"x-api-key\"] = apiKey;\n  if (method !== \"GET\") headers[\"content-type\"] = \"application/json\";\n\n  for (let attempt = 0; attempt <= retries; attempt += 1) {\n    const controller = new AbortController();\n    const timer = setTimeout(() => controller.abort(), timeoutMs);\n    try {\n      const res = await fetch(url, {\n        method,\n        headers,\n        body: method === \"GET\" ? undefined : JSON.stringify(options.body ?? {}),\n        signal: controller.signal,\n      });\n\n      const text = await res.text();\n      const body = text.length ? safeJsonParse(text) : null;\n\n      if (res.ok) return body as T;\n\n      if ((res.status === 429 || res.status === 503) && attempt < retries) {\n        const backoffMs = 500 * Math.pow(2, attempt);\n        await sleep(backoffMs);\n        continue;\n      }\n\n      throw new ApiError(\n        `Request failed (${res.status})`,\n        res.status,\n        url,\n        body,\n      );\n    } catch (err) {\n      if (err instanceof ApiError) throw err;\n      if (err instanceof Error && err.name === \"AbortError\") {\n        if (attempt < retries) continue;\n        throw new NetworkError(`Request timed out after ${timeoutMs}ms`);\n      }\n      if (attempt < retries) continue;\n      throw new NetworkError(\n        err instanceof Error ? err.message : \"Network error\",\n      );\n    } finally {\n      clearTimeout(timer);\n    }\n  }\n\n  throw new NetworkError(\"Request failed after retries\");\n}\n\nfunction safeJsonParse(text: string): unknown {\n  try {\n    return JSON.parse(text);\n  } catch {\n    return text;\n  }\n}\n","import { requestJson } from \"./client\";\nimport { getMetadataApiBase } from \"../utils/config\";\nimport type {\n  EventsResponse,\n  EventResponse,\n  MarketsResponse,\n  MarketResponse,\n  SeriesListResponse,\n  SeriesResponseSingle,\n  TagsByCategoriesResponse,\n  SearchResponse,\n  TradesResponse,\n  FilterOutcomeMintsRequest,\n  FilterOutcomeMintsResponse,\n} from \"../types/api\";\nimport type { Orderbook, SortField, SortMethod } from \"../types/domain\";\n\nconst base = () => getMetadataApiBase();\n\nexport async function getEvents(opts: {\n  limit?: number;\n  cursor?: number;\n  seriesTickers?: string;\n  status?: string;\n  isInitialized?: boolean;\n  sort?: SortField;\n  order?: SortMethod;\n  withNestedMarkets?: boolean;\n}): Promise<EventsResponse> {\n  return requestJson<EventsResponse>(base(), \"/api/v1/events\", {\n    query: {\n      limit: opts.limit,\n      cursor: opts.cursor,\n      seriesTickers: opts.seriesTickers,\n      status: opts.status,\n      isInitialized: opts.isInitialized,\n      sort: opts.sort,\n      order: opts.order,\n      withNestedMarkets: opts.withNestedMarkets,\n    },\n  });\n}\n\nexport async function getEvent(\n  eventId: string,\n  opts?: { withNestedMarkets?: boolean },\n): Promise<EventResponse> {\n  return requestJson<EventResponse>(base(), `/api/v1/event/${eventId}`, {\n    query: { withNestedMarkets: opts?.withNestedMarkets },\n  });\n}\n\nexport async function getMarkets(opts: {\n  limit?: number;\n  cursor?: number;\n  status?: string;\n  isInitialized?: boolean;\n  sort?: SortField;\n  order?: SortMethod;\n}): Promise<MarketsResponse> {\n  return requestJson<MarketsResponse>(base(), \"/api/v1/markets\", {\n    query: {\n      limit: opts.limit,\n      cursor: opts.cursor,\n      status: opts.status,\n      isInitialized: opts.isInitialized,\n      sort: opts.sort,\n      order: opts.order,\n    },\n  });\n}\n\nexport async function getMarket(marketId: string): Promise<MarketResponse> {\n  return requestJson<MarketResponse>(base(), `/api/v1/market/${marketId}`);\n}\n\nexport async function getMarketByMint(\n  mintAddress: string,\n): Promise<MarketResponse> {\n  return requestJson<MarketResponse>(\n    base(),\n    `/api/v1/market/by-mint/${mintAddress}`,\n  );\n}\n\nexport async function getOrderbookByTicker(\n  marketTicker: string,\n): Promise<Orderbook> {\n  return requestJson<Orderbook>(base(), `/api/v1/orderbook/${marketTicker}`);\n}\n\nexport async function getOrderbookByMint(\n  mintAddress: string,\n): Promise<Orderbook> {\n  return requestJson<Orderbook>(base(), `/api/v1/orderbook/by-mint/${mintAddress}`);\n}\n\nexport async function getSeries(opts: {\n  category?: string;\n  tags?: string;\n  isInitialized?: boolean;\n  status?: string;\n}): Promise<SeriesListResponse> {\n  return requestJson<SeriesListResponse>(base(), \"/api/v1/series\", {\n    query: {\n      category: opts.category,\n      tags: opts.tags,\n      isInitialized: opts.isInitialized,\n      status: opts.status,\n    },\n  });\n}\n\nexport async function getSeriesByTicker(\n  seriesTicker: string,\n): Promise<SeriesResponseSingle> {\n  return requestJson<SeriesResponseSingle>(\n    base(),\n    `/api/v1/series/${seriesTicker}`,\n  );\n}\n\nexport async function getTagsByCategories(): Promise<TagsByCategoriesResponse> {\n  return requestJson<TagsByCategoriesResponse>(\n    base(),\n    \"/api/v1/tags_by_categories\",\n  );\n}\n\nexport async function searchEvents(opts: {\n  q: string;\n  sort?: SortField;\n  order?: SortMethod;\n  limit?: number;\n  cursor?: number;\n  withNestedMarkets?: boolean;\n  withMarketAccounts?: boolean;\n}): Promise<SearchResponse> {\n  return requestJson<SearchResponse>(base(), \"/api/v1/search\", {\n    query: {\n      q: opts.q,\n      sort: opts.sort,\n      order: opts.order,\n      limit: opts.limit,\n      cursor: opts.cursor,\n      withNestedMarkets: opts.withNestedMarkets,\n      withMarketAccounts: opts.withMarketAccounts,\n    },\n  });\n}\n\nexport async function getTrades(opts: {\n  limit?: number;\n  cursor?: string;\n  ticker?: string;\n  minTs?: number;\n  maxTs?: number;\n}): Promise<TradesResponse> {\n  return requestJson<TradesResponse>(base(), \"/api/v1/trades\", {\n    query: {\n      limit: opts.limit,\n      cursor: opts.cursor,\n      ticker: opts.ticker,\n      minTs: opts.minTs,\n      maxTs: opts.maxTs,\n    },\n  });\n}\n\nexport async function getTradesByMint(\n  mintAddress: string,\n): Promise<TradesResponse> {\n  return requestJson<TradesResponse>(\n    base(),\n    `/api/v1/trades/by-mint/${mintAddress}`,\n  );\n}\n\nexport async function filterOutcomeMints(\n  addresses: string[],\n): Promise<FilterOutcomeMintsResponse> {\n  const body: FilterOutcomeMintsRequest = { addresses };\n  return requestJson<FilterOutcomeMintsResponse>(base(), \"/api/v1/filter_outcome_mints\", {\n    method: \"POST\",\n    body,\n  });\n}\n"],"mappings":"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"}